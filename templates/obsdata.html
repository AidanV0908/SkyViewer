<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/skyviewer.css') }}">
    <title>Collect Observational Data</title>
    <style>
        body {  
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            background-color: #f0f0f0;
        }
        fieldset {
            border: 1px solid #ccc; /* Border for fieldset */
            margin: 15px 0; /* Margin for fieldset */
            padding: 10px; /* Padding for fieldset */
            width: 90%; /* Make fieldset responsive */
            max-width: 500px; /* Set a max width for better readability */
        }
        .form-row {
            display: flex; /* Use flexbox to align items */
            justify-content: space-between; /* Space between items */
            margin: 10px 0; /* Margin for each row */
        }
        input[type="date"],
        input[type="time"],
        input[type="number"] {
            flex: 1; /* Allow inputs to take equal space */
            margin-right: 10px; /* Space between inputs */
        }
        button {
            padding: 10px 15px; /* Add padding for buttons */
            margin: 0 5px; /* Space between buttons */
            background-color: #007bff; /* Button color */
            color: white; /* Button text color */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Cursor on hover */
            transition: background-color 0.3s; /* Transition for hover effect */
        }
        button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }
    </style>
</head>
<body>
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-step complete"></div>
            <div class="progress-step complete"></div>
            <div class="progress-step incomplete"></div>
        </div>
    </div>
    <div class="error-box" id="errorBox" style="margin-top: 5px">
        Failed to submit current data. Make sure location is enabled and try again.
    </div>

    <h1 style="margin-bottom:0; margin-left: 10%; margin-right: 10%;">Step 2: Enter Observational Data</h1>
    <p style="margin-left: 10%; margin-right: 10%;">This page collects data on the ground station for observational data. It is automatically
        set to the current time and location. Latitude and longitude are the geodetic latitudes and longitudes, and are provided by Google Maps.</p>

    <h3>Use Current Location and Time</h3>
    <div style="flex-wrap: nowrap">
        <label for="enableCurrent" style="flex:80%;">Use Current Date and Time: </label>
        <input type="checkbox" id="enableCurrent" name="enableCurrent" style="flex:20%" checked onclick="toggleFields()">
    </div>
    <h5>-OR -</h5>
    <h3>Enter Custom Location and Time</h3>

    <input type="hidden" id="id_field" name="satelliteId" value="{{satellite_id}}">

    <!-- Date, Time, Time Zone on the same row -->
    <fieldset>
        <legend>Time Data</legend>
        <div class="form-row">
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" class="toggleField" placeholder="Date" required>
        </div>
        <div class="form-row">
            <label for="time">Time:</label>
            <input type="time" id="time" step="1" name="time" class="toggleField" placeholder="Time" required>
        </div>
        <div class="form-row">
            <label for="timezone">UTC (+/-):</label>
            <input type="number" name="timezone" id="timezone" class="toggleField" placeholder="Time Zone" min="-12" max="14" step="0.5" required>
        </div>
    </fieldset>

    <!-- Latitude and Longitude on the same row -->
    <fieldset>
        <legend>Geodetic Coordinates</legend>
        <div class="form-row">
            <label for="latitude">Latitude (Degrees):</label>
            <input type="number" name="latitude" class="toggleField" id="latitude" placeholder="Latitude" min="-90" max="90" step="any" required>
        </div>
        <div class="form-row">
            <label for="longitude">Longitude (Degrees):</label>
            <input type="number" name="longitude" class="toggleField" id="longitude" placeholder="Longitude" min="-180" max="180" step="any" required>
        </div>
    </fieldset>

    <!-- Submit and Skip buttons -->
    <div style="text-align: center;">
        <button type="submit" onclick="submitData()">Submit</button>
    </div>

    <script>
        async function submitData() {
            const useCurrentCheckbox = document.getElementById("enableCurrent");
            const errorBox = document.getElementById("errorBox");

            // Hide error box initially
            errorBox.style.display = "none";

            let date, time, timezone, latitude, longitude, formattedTime;

            if (useCurrentCheckbox.checked) {
                const now = new Date();
                date = now.toISOString().split('T')[0];
                formattedTime = now.toTimeString().split(' ')[0];
                timezone = -now.getTimezoneOffset() / 60;

                try {
                    const position = await getCurrentPosition();
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                } catch (error) {
                    console.error("Geolocation error:", error); // Log error for debugging

                    // Update the error message based on the error
                    if (error.code === error.PERMISSION_DENIED) {
                        errorBox.innerText = "Location access denied. Please enable location permissions.";
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorBox.innerText = "Location information is unavailable.";
                    } else if (error.code === error.TIMEOUT) {
                        errorBox.innerText = "Location request timed out. Please try again.";
                    } else {
                        errorBox.innerText = "Failed to obtain location. Please ensure location services are enabled.";
                    }
                    errorBox.style.display = "block";
                    return;
                }
            } else {
                // Get custom values from input fields
                date = document.getElementById("date").value;
                time = document.getElementById("time").value;

                // Extract hours, minutes, and seconds with padding
                if (time) {
                    let [hours, minutes, seconds = '00'] = time.split(':');
                    hours = hours.padStart(2, '0');
                    minutes = minutes.padStart(2, '0');
                    seconds = seconds.padStart(2, '0');

                    // Format time as HHMMSS
                    formattedTime = `${hours}${minutes}${seconds}`;
                }

                timezone = document.getElementById("timezone").value;
                latitude = document.getElementById("latitude").value;
                longitude = document.getElementById("longitude").value;
            }

            // Validate required fields
            if (!date || !formattedTime || !timezone || !latitude || !longitude) {
                errorBox.style.display = "block";
                errorBox.innerText = "Verification failed: Missing required fields.";
                return;
            }

            // Get satellite ID
            const satelliteId = document.getElementById("id_field").value;

            // Construct URL with query parameters
            const url = `/results?satelliteId=${satelliteId}&date=${date}&time=${formattedTime}&timezone=${timezone}&latitude=${latitude}&longitude=${longitude}`;

            // Redirect to the results page
            window.location.href = url;
        }

        function getCurrentPosition() {
            // Returns a promise to get the current position or throw an error if failed
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }); // 10s timeout
            });
        }

        function toggleFields() {
            const checkbox = document.getElementById("enableCurrent");
            const fields = document.querySelectorAll(".toggleField");

            // Disable fields when checkbox is checked, enable them when unchecked
            fields.forEach(field => {
                field.disabled = checkbox.checked;
            });
        }

        // Initialize the fields on page load based on the checkbox's default state
        document.addEventListener("DOMContentLoaded", toggleFields);
    </script>
</body>

</html>


